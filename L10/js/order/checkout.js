import {Dish, dishes, chosenDishes} from '../modules/dishes.js';
import {Order} from '../modules/orders.js';
import {loadDishes, postOrder} from '../modules/api.js';
import {isOrderTimeValid} from '../modules/validators.js';
import {
    createHTMLDishCard, 
    createHTMLNotification,
    createHTMLSuccessNotification,
    createHTMLErrorNotification,
} from '../modules/components.js';

let hiddenOnce = false;

let dishSummaryDefaultValues = {
    "soup": "–°—É–ø –Ω–µ –≤—ã–±—Ä–∞–Ω",
    "main-course": "–ì–ª–∞–≤–Ω–æ–µ –±–ª—é–¥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ",
    "salad": "–°–∞–ª–∞—Ç –∏–ª–∏ —Å—Ç–∞—Ä—Ç–µ—Ä –Ω–µ –≤—ã–±—Ä–∞–Ω",
    "drink": "–ù–∞–ø–∏—Ç–æ–∫ –Ω–µ –≤—ã–±—Ä–∞–Ω",
    "dessert": "–î–µ—Å–µ—Ä—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω"
};

function updateOrderSummary(dish, adding, orderSummary = null) {
    if (!orderSummary) {
        orderSummary = document.querySelector(".select-container");
    }
    let select = orderSummary.querySelector(`#${dish.category}-select`);
    if (adding) {
        select.lastElementChild.innerHTML = `${dish.name} ${dish.price}&#8381;`;
        select.firstElementChild.value = dish.id; // hidden input
    } else {
        select.lastElementChild.innerHTML 
            = dishSummaryDefaultValues[dish.category];
        select.firstElementChild.value = ''; // hidden input
    }

    orderSummary.querySelector(".select > .price")
        .innerHTML = `${chosenDishes.calculatePrice()}&#8381;`;

    let chosen = chosenDishes.anyChosen();
    if ((!chosen && hiddenOnce) || (!hiddenOnce && chosen)) {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã –¥–ª—è –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –±–ª—é–¥ –ø—Ä–∏ chosen == false
        // –ü—Ä—è—á–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã –¥–ª—è –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –±–ª—é–¥ –ø—Ä–∏ chosen == true
        document.querySelectorAll(".to-hide")
            .forEach((value) => value.hidden = chosen);
        hiddenOnce = chosen;
    }
    // –°–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º–∏ –±–ª—é–¥–∞–º–∏ –ø—Ä–∏ chosen == false
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º–∏ –±–ª—é–¥–∞–º–∏ –ø—Ä–∏ chosen == true
    orderSummary.hidden = !chosen;
}

function processDish(dish, adding) {
    if (!adding) {
        chosenDishes.removeDish(dish.category);
    } else {
        chosenDishes.addDish(dish);
    }
    dish.card.hidden = !adding;
    updateOrderSummary(dish, adding);
}

function dishButtonHandler(event) {
    let dishContainer = event.currentTarget.parentElement;
    let dish = dishContainer.dish;
    
    processDish(dish, chosenDishes[dish.category] != dish);
}

async function submit() {
    let form = document.getElementById("order-form");
    let formData = new FormData(form);
    formData.set(
        "subscribe",
        String(Number(formData.get("subscribe") == "on"))
    );

    console.log(...formData);

    postOrder(formData)
        .then(() => {
            let message = createHTMLSuccessNotification(
                "–ó–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!");

            for (let dish of chosenDishes.getChosen()) {
                processDish(dish, false);
            }
            document.body.append(message);
        })
        .catch((error) => {
            let message = createHTMLErrorNotification(error.message);
            document.body.append(message);
        });
}

function submitHandler(event) {
    if (!chosenDishes.isCombo()) {
        document.body.append(
            createHTMLNotification(chosenDishes.comboText(), "–û–∫–µ–π üëå"));

        event.preventDefault();
        return false;
    }

    let form = document.forms[0];

    if (form.elements["delivery_type"].value == "by_time"
        && !isOrderTimeValid(form.elements["delivery_time"].value)
    ) {
        document.body.append(
            createHTMLNotification(
                "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –∑–∞–∫–∞–∑–∞.", 
                "–û–∫–µ–π üëå"
            ));

        event.preventDefault();
        return false;
    }

    submit();

    event.preventDefault();
    return true;
}

function onloadHandler() {
    loadDishes().then(
        () => {
            dishes.sort((a, b) => a.name.localeCompare(b.name));
            chosenDishes.load(dishButtonHandler);
            for (let dish of chosenDishes.getChosen()) {
                let container = document.querySelector('.dishes');
                container.append(createHTMLDishCard(dish, dishButtonHandler));

                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –±–ª—é–¥–∞ –±–µ–∑ –∫–ª–∞—Å—Å–∞
                dish.setChosen(false);

                updateOrderSummary(dish, true);
            }
        }
    );
}

window.onload = onloadHandler;
document.getElementById("order-form").addEventListener("submit", submitHandler);